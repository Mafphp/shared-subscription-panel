<!doctype html>
<html>
  <head>
    <title>Admin Panel - Node Manager</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #e5e7eb;
        padding: 20px;
        margin: 0;
        min-height: 100vh;
      }
      .card {
        background: rgba(2, 6, 23, 0.95);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 16px;
        max-width: 1200px;
        margin: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(30, 41, 59, 0.5);
      }
      h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #f1f5f9;
        font-size: 2em;
        font-weight: 600;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #94a3b8;
      }
      input, textarea {
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #334155;
        background: #020617;
        color: #e5e7eb;
        width: 100%;
        box-sizing: border-box;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      input:focus, textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      button {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s, transform 0.1s;
        width: 100%;
        margin-top: 10px;
      }
      button:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        transform: translateY(-1px);
      }
      button:active {
        transform: translateY(0);
      }
      .action-btn {
        width: auto;
        padding: 6px 12px;
        font-size: 0.9em;
        margin: 2px;
        background: #059669;
      }
      .action-btn:hover {
        background: #047857;
      }
      .delete-btn {
        background: #dc2626;
      }
      .delete-btn:hover {
        background: #b91c1c;
      }
      .up-btn {
        background: #eab308;
        color: #000;
      }
      .up-btn:hover {
        background: #ca8a04;
      }
      .down-btn {
        background: #06b6d4;
        color: #000;
      }
      .down-btn:hover {
        background: #0891b2;
      }
      .edit-btn {
        background: #8b5cf6;
      }
      .edit-btn:hover {
        background: #7c3aed;
      }
      .bulk-delete-btn {
        background: #dc2626;
        width: auto;
        padding: 10px 20px;
        margin: 10px 0;
      }
      .bulk-delete-btn:hover {
        background: #b91c1c;
      }
      .login-card {
        max-width: 400px;
        text-align: center;
      }
      .admin-panel {
        display: none;
      }
      table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        background: rgba(2, 6, 23, 0.8);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      }
      th {
        background: #1e293b;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: #f1f5f9;
        border-bottom: 2px solid #334155;
      }
      th input[type="checkbox"] {
        margin-right: 10px;
      }
      tr:nth-child(even) {
        background: rgba(30, 41, 59, 0.3);
      }
      td {
        padding: 12px;
        border-bottom: 1px solid #334155;
        word-break: break-all;
        max-width: 300px;
      }
      td[contenteditable] {
        background: rgba(37, 99, 235, 0.1);
        cursor: text;
        border-radius: 4px;
        padding: 8px;
        transition: background 0.2s;
      }
      td[contenteditable]:focus {
        background: rgba(37, 99, 235, 0.2);
        outline: 2px solid #2563eb;
      }
      .error, .success {
        margin-top: 15px;
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
      }
      .error {
        color: #f87171;
        background: rgba(248, 113, 113, 0.1);
        border: 1px solid #f87171;
      }
      .success {
        color: #10b981;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid #10b981;
      }
      hr {
        border: none;
        height: 1px;
        background: linear-gradient(to right, transparent, #334155, transparent);
        margin: 25px 0;
      }
      #editModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
      }
      .modal-content {
        background: #020617;
        margin: 10% auto;
        padding: 20px;
        border-radius: 10px;
        max-width: 500px;
        color: #e5e7eb;
        border: 1px solid #334155;
      }
      .modal-content label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        font-weight: 500;
        color: #94a3b8;
      }
      .modal-content input, .modal-content textarea {
        width: 100%;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #334155;
        background: #020617;
        color: #e5e7eb;
        box-sizing: border-box;
      }
      .modal-buttons {
        text-align: right;
        margin-top: 20px;
      }
      .modal-buttons button {
        width: auto;
        margin-left: 10px;
        padding: 10px 20px;
      }
      .cancel-btn {
        background: #6b7280;
      }
      .save-btn {
        background: #10b981;
      }
      @media (max-width: 768px) {
        .card { padding: 20px; }
        table { font-size: 0.9em; }
        td, th { padding: 8px 6px; }
      }
    </style>
  </head>
  <body>
    <div id="loginDiv" class="card login-card">
      <h2>Admin Login</h2>
      <label for="token">Enter Admin Token:</label>
      <input id="token" type="password" placeholder="Admin Token" />
      <button onclick="login()">Login</button>
      <div id="loginMsg"></div>
    </div>

    <div id="adminDiv" class="card admin-panel">
      <button onclick="logout()" style="float:right; background:#dc2626; width:auto; padding:10px;">Logout</button>
      <h2>Admin Panel</h2>

      <label for="newName">Optional Name for New Records</label>
      <input id="newName" placeholder="e.g., My VMess Node" />
      <label for="newPriority">Priority (0-999)</label>
      <input id="newPriority" type="number" min="0" max="999" value="0" />
      <hr />

      <label for="newLink">Single Link</label>
      <input id="newLink" placeholder="Enter vmess:// or vless:// link" />
      <button onclick="add()">Add Record</button>

      <hr />

      <label for="bulk">Bulk Links (One Per Line)</label>
      <textarea id="bulk" rows="6" placeholder="Paste multiple vmess:// or vless:// links, one per line"></textarea>
      <button onclick="bulkAdd()">Bulk Add Records</button>

      <div id="msg"></div>

      <hr />
      <div>
        <label><input type="checkbox" id="selectAll" onclick="toggleSelectAll()" /> Select All</label>
        <button class="bulk-delete-btn" onclick="deleteSelected()">Delete Selected</button>
      </div>
      <table id="tbl">
        <thead>
          <tr><th><input type="checkbox" id="headerCheckbox" onclick="toggleSelectAll()" /></th><th>ID</th><th>Priority</th><th>Name</th><th>Link</th><th>Actions</th></tr>
        </thead>
      </table>

      <br />
      <button onclick="loadNodes()">Load/Refresh Nodes</button>

      <!-- Edit Modal -->
      <div id="editModal">
        <div class="modal-content">
          <h3>Edit Record</h3>
          <label for="editName">Name:</label>
          <input id="editName" type="text" />
          <label for="editPriority">Priority:</label>
          <input id="editPriority" type="number" min="0" max="999" />
          <label for="editLink">Link:</label>
          <textarea id="editLink" rows="4"></textarea>
          <div class="modal-buttons">
            <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
            <button class="save-btn" onclick="saveEdit()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const TOKEN_KEY = 'adminToken';
      let currentData = [];
      let token = localStorage.getItem(TOKEN_KEY) || '';

      // Check if token is valid on load
      if (token) {
        validateToken().then(valid => {
          if (valid) {
            document.getElementById('adminDiv').style.display = 'block';
            document.getElementById('loginDiv').style.display = 'none';
            loadNodes();
          } else {
            localStorage.removeItem(TOKEN_KEY);
            token = '';
          }
        });
      }

      async function validateToken() {
        try {
          const r = await fetch('/api/nodes?token=' + token);
          return r.ok;
        } catch {
          return false;
        }
      }

      function login() {
        token = document.getElementById('token').value.trim();
        if (!token) {
          showLoginMsg('Token required', 'error');
          return;
        }
        validateToken().then(valid => {
          if (valid) {
            localStorage.setItem(TOKEN_KEY, token);
            document.getElementById('adminDiv').style.display = 'block';
            document.getElementById('loginDiv').style.display = 'none';
            loadNodes();
          } else {
            showLoginMsg('Invalid token', 'error');
          }
        });
      }

      function logout() {
        localStorage.removeItem(TOKEN_KEY);
        token = '';
        document.getElementById('adminDiv').style.display = 'none';
        document.getElementById('loginDiv').style.display = 'block';
        document.getElementById('token').value = '';
      }

      function showLoginMsg(text, className) {
        const msg = document.getElementById('loginMsg');
        msg.innerText = text;
        msg.className = className;
        setTimeout(() => { msg.innerText = ''; msg.className = ''; }, 3000);
      }

      async function loadNodes(){
        if (!token) return;
        const msgEl = document.getElementById('msg');
        msgEl.innerText = "";
        msgEl.className = "";
        const r = await fetch('/api/nodes?token='+token);
        if(!r.ok){
          if (r.status === 403) {
            logout();
            return;
          }
          msgEl.innerText="Failed to load nodes"; msgEl.className="error";return;
        }
        const d = await r.json();
        currentData = d; // Update cache
        const tbl = document.getElementById('tbl');
        tbl.innerHTML = '<tr><th><input type="checkbox" id="headerCheckbox" onclick="toggleSelectAll()" /></th><th>ID</th><th>Priority</th><th>Name</th><th>Link</th><th>Actions</th></tr>';
        d.forEach(n=>{
          tbl.innerHTML+=`
          <tr>
            <td><input type="checkbox" class="rowCheckbox" value="${n.id}" /></td>
            <td>${n.id}</td>
            <td contenteditable onblur="editPriority(${n.id},this.innerText)">${n.priority || 0}</td>
            <td contenteditable onblur="edit(${n.id},this.innerText,null)">${n.name}</td>
            <td contenteditable onblur="edit(${n.id},null,this.innerText)">${n.link}</td>
            <td>
              <button class="action-btn edit-btn" onclick="openEditModal(${n.id})">Edit</button>
              <button class="action-btn up-btn" onclick="moveUp(${n.id})">‚Üë</button>
              <button class="action-btn down-btn" onclick="moveDown(${n.id})">‚Üì</button>
              <button class="action-btn delete-btn" onclick="del(${n.id})">üóëÔ∏è</button>
            </td>
          </tr>`;
        });
      }

      function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.rowCheckbox');
        const checked = document.getElementById('headerCheckbox').checked;
        checkboxes.forEach(cb => cb.checked = checked);
      }

      async function deleteSelected() {
        const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
        if (checkboxes.length === 0) {
          showMsg('No records selected', 'error');
          return;
        }
        if (!confirm(`Delete ${checkboxes.length} selected records?`)) return;
        let success = 0;
        for (let cb of checkboxes) {
          const id = parseFloat(cb.value);
          const r = await fetch('/api/nodes/' + id + '?token=' + token, {method:'DELETE'});
          if (r.ok) success++;
        }
        currentData = [];
        loadNodes();
        showMsg(`Deleted ${success} records`, 'success');
      }

      async function add(){
        if (!token) return;
        const msgEl = document.getElementById('msg');
        msgEl.innerText = ""; msgEl.className = "";
        const r = await fetch('/api/nodes?token='+token,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name:newName.value,link:newLink.value,priority: parseInt(newPriority.value) || 0})
        });
        if(r.ok){
          newName.value=""; newLink.value=""; newPriority.value = "0";
          currentData = []; // Invalidate cache
          loadNodes();
          showMsg("Added successfully!", "success");
        } else {
          showMsg("Failed to add record", "error");
        }
      }

      async function bulkAdd(){
        if (!token) return;
        const msgEl = document.getElementById('msg');
        msgEl.innerText = ""; msgEl.className = "";
        const r = await fetch('/api/bulk?token='+token,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name:newName.value,text:bulk.value})
        });
        if(r.ok){
          bulk.value="";
          currentData = []; // Invalidate cache
          loadNodes();
          showMsg("Bulk added successfully!", "success");
        } else {
          showMsg("Failed to bulk add", "error");
        }
      }

      async function edit(id,name,link){
        if (!token) return;
        const p={};
        if(name!==null)p.name=name;
        if(link!==null)p.link=link;
        const r = await fetch('/api/nodes/'+id+'?token='+token,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(p)
        });
        if(r.ok){
          currentData = []; // Invalidate cache
          showMsg("Updated successfully!", "success");
        } else {
          showMsg("Update failed", "error");
        }
      }

      async function editPriority(id, priority) {
        if (!token) return;
        const p = { priority: parseInt(priority) || 0 };
        const r = await fetch('/api/nodes/'+id+'?token='+token,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(p)
        });
        if(r.ok){
          currentData = []; // Invalidate cache
          showMsg("Priority updated!", "success");
        } else {
          showMsg("Priority update failed", "error");
        }
      }

      async function del(id){
        if (!token) return;
        const r = await fetch('/api/nodes/'+id+'?token='+token,{method:'DELETE'});
        if(r.ok){
          currentData = []; // Invalidate cache
          loadNodes();
          showMsg("Deleted successfully!", "success");
        } else {
          showMsg("Delete failed", "error");
        }
      }

      async function moveUp(id) {
        const idx = currentData.findIndex(x => x.id == id);
        if (idx > 0) {
          [currentData[idx-1], currentData[idx]] = [currentData[idx], currentData[idx-1]];
          await saveReordered();
          loadNodes();
          showMsg("Moved up!", "success");
        }
      }
      async function moveDown(id) {
        const idx = currentData.findIndex(x => x.id == id);
        if (idx < currentData.length - 1) {
          [currentData[idx], currentData[idx+1]] = [currentData[idx+1], currentData[idx]];
          await saveReordered();
          loadNodes();
          showMsg("Moved down!", "success");
        }
      }
      async function saveReordered() {
        await fetch('/api/nodes/reorder?token='+token, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({data: currentData})
        });
      }

      function showMsg(text, className) {
        const msg = document.getElementById('msg');
        msg.innerText = text;
        msg.className = className;
        setTimeout(() => { msg.innerText = ""; msg.className = ""; }, 2000);
      }

      let editingId = null;

      function openEditModal(id) {
        editingId = id;
        const node = currentData.find(x => x.id == id);
        if (!node) {
          showMsg("Record not found", "error");
          return;
        }
        document.getElementById('editName').value = node.name || '';
        document.getElementById('editPriority').value = node.priority || 0;
        document.getElementById('editLink').value = node.link || '';
        document.getElementById('editModal').style.display = 'block';
      }

      function closeEditModal() {
        editingId = null;
        document.getElementById('editModal').style.display = 'none';
      }

      async function saveEdit() {
        if (!token) return;
        const name = document.getElementById('editName').value;
        const priority = document.getElementById('editPriority').value;
        const link = document.getElementById('editLink').value;
        const p = {};
        if (name) p.name = name;
        if (priority !== '') p.priority = parseInt(priority) || 0;
        if (link) p.link = link;
        const r = await fetch('/api/nodes/' + editingId + '?token=' + token, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(p)
        });
        if (r.ok) {
          currentData = [];
          loadNodes();
          closeEditModal();
          showMsg("Record updated!", "success");
        } else {
          showMsg("Save failed", "error");
        }
      }

      // Close modal on outside click
      window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
          closeEditModal();
        }
      }

      // Enter key for login
      document.getElementById('token').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
      });
    </script>
  </body>
</html>