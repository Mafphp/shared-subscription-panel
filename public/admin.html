<!doctype html>
<html>
  <head>
    <title>Admin Panel - Node Manager</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #e5e7eb;
        padding: 20px;
        margin: 0;
        min-height: 100vh;
      }
      .card {
        background: rgba(2, 6, 23, 0.95);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 16px;
        max-width: 1200px;
        margin: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(30, 41, 59, 0.5);
      }
      h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #f1f5f9;
        font-size: 2em;
        font-weight: 600;
      }
      .input-row {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }
      .input-row label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #94a3b8;
      }
      .input-row input {
        flex: 1;
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #334155;
        background: #020617;
        color: #e5e7eb;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .input-row input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      .input-row .priority-input {
        flex: 0 0 120px;
        max-width: 120px;
      }
      input, textarea {
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #334155;
        background: #020617;
        color: #e5e7eb;
        width: 100%;
        box-sizing: border-box;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      input:focus, textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      button {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s, transform 0.1s;
        width: 100%;
        margin-top: 10px;
      }
      button:hover:not(:disabled) {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        transform: translateY(-1px);
      }
      button:active:not(:disabled) {
        transform: translateY(0);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .action-btn {
        width: auto;
        padding: 6px 12px;
        font-size: 0.9em;
        margin: 2px;
        background: #059669;
      }
      .action-btn:hover:not(:disabled) {
        background: #047857;
      }
      .delete-btn {
        background: #dc2626;
      }
      .delete-btn:hover:not(:disabled) {
        background: #b91c1c;
      }
      .edit-btn {
        background: #8b5cf6;
      }
      .edit-btn:hover:not(:disabled) {
        background: #7c3aed;
      }
      .save-btn-row {
        background: #10b981;
      }
      .save-btn-row:hover:not(:disabled) {
        background: #059669;
      }
      .cancel-btn-row {
        background: #6b7280;
      }
      .cancel-btn-row:hover:not(:disabled) {
        background: #4b5563;
      }
      .bulk-delete-btn {
        background: #dc2626;
        width: auto;
        padding: 10px 20px;
        margin: 10px 0;
      }
      .bulk-delete-btn:hover:not(:disabled) {
        background: #b91c1c;
      }
      .bulk-delete-btn:disabled {
        background: #6b7280;
        cursor: not-allowed;
      }
      .login-card {
        max-width: 400px;
        text-align: center;
      }
      .admin-panel {
        display: none;
      }
      table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        background: rgba(2, 6, 23, 0.8);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      }
      th {
        background: #1e293b;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: #f1f5f9;
        border-bottom: 2px solid #334155;
      }
      th input[type="checkbox"] {
        margin-right: 10px;
      }
      tr {
        transition: background 0.2s;
      }
      tr.editing {
        background: rgba(139, 92, 246, 0.1);
      }
      tr:nth-child(even) {
        background: rgba(30, 41, 59, 0.3);
      }
      tr.editing:nth-child(even) {
        background: rgba(139, 92, 246, 0.2);
      }
      td {
        padding: 12px;
        border-bottom: 1px solid #334155;
        word-break: break-all;
        max-width: 300px;
      }
      td.readonly {
        background: rgba(30, 41, 59, 0.5);
        cursor: default;
      }
      td.editable {
        background: rgba(37, 99, 235, 0.1);
        cursor: text;
      }
      td.editable:focus-within {
        background: rgba(37, 99, 235, 0.2);
        outline: 2px solid #2563eb;
      }
      /* Checkbox Styling */
      input[type="checkbox"] {
        appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid #334155;
        border-radius: 4px;
        background: #020617;
        cursor: pointer;
        position: relative;
        margin: 0;
        vertical-align: middle;
      }
      input[type="checkbox"]:checked {
        background: #10b981;
        border-color: #10b981;
      }
      input[type="checkbox"]:checked::after {
        content: 'âœ“';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
        font-weight: bold;
      }
      input[type="checkbox"]:hover {
        border-color: #475569;
        box-shadow: 0 0 0 3px rgba(71, 85, 105, 0.2);
      }
      input[type="checkbox"]:focus {
        outline: 2px solid #2563eb;
        outline-offset: 2px;
      }
      th input[type="checkbox"] {
        width: 20px;
        height: 20px;
      }
      .error, .success {
        margin-top: 15px;
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
      }
      .error {
        color: #f87171;
        background: rgba(248, 113, 113, 0.1);
        border: 1px solid #f87171;
      }
      .success {
        color: #10b981;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid #10b981;
      }
      hr {
        border: none;
        height: 1px;
        background: linear-gradient(to right, transparent, #334155, transparent);
        margin: 25px 0;
      }
      @media (max-width: 768px) {
        .card { padding: 20px; }
        .input-row { flex-direction: column; gap: 10px; }
        .input-row .priority-input { max-width: none; }
        table { font-size: 0.9em; }
        td, th { padding: 8px 6px; }
      }
    </style>
  </head>
  <body>
    <div id="loginDiv" class="card login-card">
      <h2>Admin Login</h2>
      <label for="token">Enter Admin Token:</label>
      <input id="token" type="password" placeholder="Admin Token" />
      <button onclick="login()">Login</button>
      <div id="loginMsg"></div>
    </div>

    <div id="adminDiv" class="card admin-panel">
      <button onclick="logout()" style="float:right; background:#dc2626; width:auto; padding:10px;">Logout</button>
      <h2>Admin Panel</h2>

      <div class="input-row">
        <div>
          <label for="newName">Optional Name for New Records (applies to all lines)</label>
          <input id="newName" placeholder="e.g., My VMess Node" />
        </div>
        <div class="priority-input">
          <label for="newPriority">Priority for All (0-999, defaults to 0)</label>
          <input id="newPriority" type="number" min="0" max="999" value="0" />
        </div>
      </div>
      <hr />

      <label for="bulk">Links (One Per Line - Single or Bulk)</label>
      <textarea id="bulk" rows="6" placeholder="Paste vmess:// or vless:// links, one per line (single: paste one line)"></textarea>
      <button onclick="bulkAdd()">Add Links</button>

      <div id="msg"></div>

      <hr />
      <div>
        <label><input type="checkbox" id="selectAll" onclick="toggleSelectAll()" /> Select All</label>
        <button class="bulk-delete-btn" id="deleteBtn" onclick="deleteSelected()" title="No records selected">Delete Selected</button>
      </div>
      <table id="tbl">
        <thead>
          <tr><th><input type="checkbox" id="headerCheckbox" onclick="toggleSelectAll()" /></th><th>ID</th><th>Priority</th><th>Name</th><th>Link</th><th>Created</th><th>Actions</th></tr>
        </thead>
      </table>

      <br />
      <button onclick="loadNodes()">Load/Refresh Nodes</button>
    </div>

    <script>
      const TOKEN_KEY = 'adminToken';
      let currentData = [];
      let token = localStorage.getItem(TOKEN_KEY) || '';

      // Check if token is valid on load
      if (token) {
        validateToken().then(valid => {
          if (valid) {
            document.getElementById('adminDiv').style.display = 'block';
            document.getElementById('loginDiv').style.display = 'none';
            loadNodes();
          } else {
            localStorage.removeItem(TOKEN_KEY);
            token = '';
          }
        });
      }

      async function validateToken() {
        try {
          const r = await fetch('/api/nodes?token=' + token);
          return r.ok;
        } catch {
          return false;
        }
      }

      function login() {
        token = document.getElementById('token').value.trim();
        if (!token) {
          showLoginMsg('Token required', 'error');
          return;
        }
        validateToken().then(valid => {
          if (valid) {
            localStorage.setItem(TOKEN_KEY, token);
            document.getElementById('adminDiv').style.display = 'block';
            document.getElementById('loginDiv').style.display = 'none';
            loadNodes();
          } else {
            showLoginMsg('Invalid token', 'error');
          }
        });
      }

      function logout() {
        localStorage.removeItem(TOKEN_KEY);
        token = '';
        document.getElementById('adminDiv').style.display = 'none';
        document.getElementById('loginDiv').style.display = 'block';
        document.getElementById('token').value = '';
      }

      function showLoginMsg(text, className) {
        const msg = document.getElementById('loginMsg');
        msg.innerText = text;
        msg.className = className;
        setTimeout(() => { msg.innerText = ''; msg.className = ''; }, 3000);
      }

      async function loadNodes(){
        if (!token) return;
        const msgEl = document.getElementById('msg');
        msgEl.innerText = "";
        msgEl.className = "";
        const r = await fetch('/api/nodes?token='+token);
        if(!r.ok){
          if (r.status === 403) {
            logout();
            return;
          }
          msgEl.innerText="Failed to load nodes"; msgEl.className="error";return;
        }
        let d = await r.json();
        // Sort by priority descending (higher first)
        d = d.sort((a, b) => (b.priority || 0) - (a.priority || 0));
        currentData = d; // Update cache
        const tbl = document.getElementById('tbl');
        tbl.innerHTML = '<tr><th><input type="checkbox" id="headerCheckbox" onclick="toggleSelectAll()" /></th><th>ID</th><th>Priority</th><th>Name</th><th>Link</th><th>Created</th><th>Actions</th></tr>';
        d.forEach(n=>{
          const createdDate = new Date(n.id).toLocaleString();
          const rowId = `row-${n.id}`;
          tbl.innerHTML+=`
          <tr id="${rowId}" class="row">
            <td><input type="checkbox" class="rowCheckbox" value="${n.id}" onchange="updateDeleteButton()" /></td>
            <td class="readonly">${n.id}</td>
            <td class="readonly editable-priority" data-original="${n.priority || 0}" contenteditable="false">${n.priority || 0}</td>
            <td class="readonly editable-name" data-original="${n.name}" contenteditable="false">${n.name}</td>
            <td class="readonly editable-link" data-original="${n.link}" contenteditable="false">${n.link}</td>
            <td class="readonly">${createdDate}</td>
            <td>
              <button class="action-btn edit-btn" onclick="toggleEdit(${n.id})">Edit</button>
              <button class="action-btn delete-btn" onclick="confirmDelete(${n.id})">Delete</button>
            </td>
          </tr>`;
        });
        updateDeleteButton(); // Initial state
      }

      function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.rowCheckbox');
        const checked = document.getElementById('headerCheckbox').checked;
        checkboxes.forEach(cb => {
          cb.checked = checked;
          updateDeleteButton();
        });
      }

      function updateDeleteButton() {
        const deleteBtn = document.getElementById('deleteBtn');
        const selected = document.querySelectorAll('.rowCheckbox:checked').length;
        deleteBtn.disabled = selected === 0;
        deleteBtn.title = selected === 0 ? 'No records selected' : `Delete ${selected} record(s)`;
      }

      async function confirmDelete(id) {
        if (!confirm('Delete this record?')) return;
        const r = await fetch('/api/nodes/' + id + '?token=' + token, {method:'DELETE'});
        if(r.ok){
          currentData = [];
          loadNodes();
          showMsg("Record deleted!", "success");
        } else {
          showMsg("Delete failed", "error");
        }
      }

      async function deleteSelected() {
        if (!token) return;
        const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
        if (checkboxes.length === 0) {
          showMsg('No records selected', 'error');
          return;
        }
        if (!confirm(`Delete ${checkboxes.length} record(s)?`)) return;
        let success = 0;
        for (let cb of checkboxes) {
          const id = parseFloat(cb.value);
          const r = await fetch('/api/nodes/' + id + '?token=' + token, {method:'DELETE'});
          if (r.ok) success++;
        }
        currentData = [];
        loadNodes();
        showMsg(`Deleted ${success} record(s)`, 'success');
      }

      async function bulkAdd(){
        if (!token) return;
        const msgEl = document.getElementById('msg');
        msgEl.innerText = ""; msgEl.className = "";
        const r = await fetch('/api/bulk?token='+token,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name:newName.value,text:bulk.value, priority: parseInt(newPriority.value) || 0})
        });
        if(r.ok){
          const resp = await r.json();
          bulk.value="";
          newName.value = "";
          newPriority.value = "0";
          currentData = []; // Invalidate cache
          loadNodes();
          showMsg(`Added ${resp.added || 0} links!`, "success");
        } else {
          try {
            const err = await r.json();
            showMsg(err.error || "Failed to add links", "error");
          } catch {
            showMsg("Failed to add links", "error");
          }
        }
      }

      function toggleEdit(id) {
        const row = document.getElementById(`row-${id}`);
        const btn = row.querySelector('.edit-btn');
        if (btn.textContent === 'Edit') {
          // Enter edit mode
          row.classList.add('editing');
          const nameTd = row.querySelector('.editable-name');
          const priorityTd = row.querySelector('.editable-priority');
          const linkTd = row.querySelector('.editable-link');
          nameTd.contentEditable = true;
          priorityTd.contentEditable = true;
          linkTd.contentEditable = true;
          btn.textContent = 'Save';
          btn.className = 'action-btn save-btn-row';
          btn.onclick = () => saveRowEdit(id, row);
          // Add cancel button
          const actionsTd = row.querySelector('td:last-child');
          const cancelBtn = document.createElement('button');
          cancelBtn.textContent = 'Cancel';
          cancelBtn.className = 'action-btn cancel-btn-row';
          cancelBtn.onclick = () => cancelEdit(id, row);
          actionsTd.appendChild(cancelBtn);
        } else {
          // Save mode - trigger save
          saveRowEdit(id, row);
        }
      }

      async function saveRowEdit(id, row) {
        const nameTd = row.querySelector('.editable-name');
        const priorityTd = row.querySelector('.editable-priority');
        const linkTd = row.querySelector('.editable-link');
        const name = nameTd.textContent.trim();
        const priority = parseInt(priorityTd.textContent.trim()) || 0;
        const link = linkTd.textContent.trim();
        if (!name || !link) {
          showMsg('Name and Link required', 'error');
          return;
        }
        const p = { name, priority, link };
        const r = await fetch('/api/nodes/' + id + '?token=' + token, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body:JSON.stringify(p)
        });
        if (r.ok) {
          currentData = [];
          loadNodes();
          showMsg("Record updated!", "success");
        } else {
          showMsg("Update failed", "error");
        }
      }

      function cancelEdit(id, row) {
        row.classList.remove('editing');
        const nameTd = row.querySelector('.editable-name');
        const priorityTd = row.querySelector('.editable-priority');
        const linkTd = row.querySelector('.editable-link');
        nameTd.contentEditable = false;
        priorityTd.contentEditable = false;
        linkTd.contentEditable = false;
        nameTd.textContent = nameTd.dataset.original;
        priorityTd.textContent = priorityTd.dataset.original;
        linkTd.textContent = linkTd.dataset.original;
        const btn = row.querySelector('.save-btn-row');
        btn.textContent = 'Edit';
        btn.className = 'action-btn edit-btn';
        btn.onclick = () => toggleEdit(id);
        const cancelBtn = row.querySelector('.cancel-btn-row');
        cancelBtn.remove();
      }

      function showMsg(text, className) {
        const msg = document.getElementById('msg');
        msg.innerText = text;
        msg.className = className;
        setTimeout(() => { msg.innerText = ""; msg.className = ""; }, 2000);
      }

      // Enter key for login
      document.getElementById('token').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
      });
    </script>
  </body>
</html>